# 2024/04/21

## RAID によるストレージの冗長構成

RAID の目的は、

1. データを複数のディスクに分散
2. 同じデータを複数のディスクで保持することで冗長化する

要するに ① データの安全性と ② パフォーマンスの向上が目的

RAID0, RAID1, RAID5, RAID10 など様々な構成があるが、具体的なところは割愛

## ファイルの物理配置

DB に関連するファイルは基本的に、以下の 5 種類が挙げられる

1. データファイル
2. インデックスファイル
3. システムファイル
4. 一時ファイル
5. ログファイル

### データファイル

その名の通り、ユーザーがデータベースに格納するデータを保持するためのファイル  
業務アプリケーションが SQL を通じてデータの参照・更新を行う

### インデックスファイル

テーブルに作成されたインデックスが格納されるファイル  
普通 DB ではテーブル(データ)とインデックスは異なるファイルとして格納される

### システムファイル

DBMS の内部管理用に使われるデータを格納するファイル

### 一時ファイル

DBMS 内部の一時的なデータを格納するためのファイル  
例えば、SQL で使われたサブクエリを展開したデータや GROUP BY や DISTINCT を利用した時のソートデータなど（処理が完了したら削除される）

### ログファイル

DBMS ではテーブルのデータに対する変更を受け付けた際に、**即座にデータファイルを更新しているわけではない** ← これ個人的にめちゃくちゃでかい学び  
一旦、このログファイうに変更文を溜め込んだのちに一括してデータファイルの更新を反映させる

## バックアップ設計

DB におけるバックアップの手法は基本的に以下の 3 種類

1. フルバックアップ
2. 差分バックアップ
3. 増分バックアップ

### フルバックアップ

その名の通り、ある時点での DB の状態を完全にバックアップする手法  
DB を完全にバックアップするためバックアップ時間(ウィンドウ)やハードウェアリソースへの負荷が高いなどのデメリットあり

またバックアップの間に新たなデータの更新があると、バックアップデータの整合性が保たれなくなるためメンテナンスとしてサービスを止める必要性があったりする

### 差分バックアップ

差分バックアップは、「最新のフルアップバックからの差分」だけのバックアップを取得する手法

#### 差分バックアップの「差分」管理はどのように？🤨

この差分管理では、先ほど登場した「ログファイル」を使用する  
差分バックアップ自体は、このログファイル(トランザクションファイル)を用いて実現する

DBMS ではユーザーからのデータの更新を受け付けた際に、即座にデータ更新を行うのではなく、トランザクションログに一旦溜め込む

このトランザクションログさえあれば、データベースに対する変更操作を再度実現することができる → **差分を取得**できる

### 増分バックアップ

増分バックアップは、差分バックアップに存在した「無駄」を解決し、効率化した手法

#### 差分バックアップにあった無駄

具体的には、月曜日にフルバックアップをしたとする

差分バックアップでは、

1. 火曜日に「火曜日に発生した変更分」をバックアップする
2. 水曜日に、月曜日からの差分である「火曜日 + 水曜日に発生した変更分」をバックアップする
3. 木曜日に、月曜日からの差分である「火曜日 + 水曜日 + 木曜日に発生した変更分」をバックアップする

といったように、差分バックアップではバックアップ自体に大きな無駄を抱えていた。

#### 増分バックアップで「無駄」を解決

増分バックアップで、どのようにして差分バックアップがかかえていた無駄を解決したかというと、**最新の増分バックアップからの変更分のみをバックアップする**ようにして解決

具体的には、月曜日にフルバックアップをしたとする

増分バックアップでは、

1. 火曜日に「火曜日に発生した変更分」をバックアップする
2. 水曜日に「最新の増分バックアップである火曜日からの変更部(= 水曜日分)をバックアップする
3. 木曜日に「最新の増分バックアップである水曜日からの変更部(= 木曜日分)をバックアップする

といったようなバックアップ手法

ただし、注意点として、増分バックアップはリカバリコスト(データの復旧にかかる時間や難易度など)がかなり高いため、メリデメのトレードオフを整理した上でバックアップ設計をする

## リカバリ設計

実際に障害が起きた際には、単にバックアップファイルをデータベースに戻しただけではダメで、そこからさらにユーザーの変更文を再度反映させる必要がある

「バックアップファイルを戻す」作業を**リストア**と呼ぶ

「そのファイルに対してトランザクションログを適応して変更分を反映させる」作業を**リカバリ**と呼ぶ
このリカバリにおいて、最も重要なのは、バックアップ済みのトランザクションログを適応させるだけじゃ足らず、DBMS 内部に存在する未バックアップのトランザクションログを適応させる**ロールフォワード**という作業を行う必要がある

### リストアおよびリカバリの手順

1. フルバックアップのファイルを DB に戻す
2. 差分(または増分)バックアップしていたトランザクションログを適応する
3. DBMS 内に残っているトランザクションログを適応する
